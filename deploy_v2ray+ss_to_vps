#!/bin/sh

self="$(cat deploy_start.sh)" && eval "$self"

export target=$1

function postinstall () {
    set -u
    echo
    echo 'Please wait copy generated client v2ray.json into local machine ...'
    scp $target:/etc/v2ray/v2ray.json ./router/opt/etc/
    echo "Run [0m[33m./deploy_v2ray_to_router admin@192.168.50.1[0m to deploy to router."
}

if grep -qs -e 'set_yours_password_here' server.json; then
    echo 'v2ray server served as a shadowsocks server too.'
    echo "You must change \`[0m[33mset_yours_password_here[0m' to a NEW password in \`./server.json'!"
    exit
fi

copy server.json /etc/v2ray/config.json

deploy_start

set -eu

# --------------------------------------------------------------------------------
#
# Following script will be run on remote VPS, please change it to meet your's need.
#
# -------------------------------------------------------------------------------

# wget https://install.direct/go.sh
# bash go.sh

[ -f /etc/systemd/system/v2ray.service ] && systemctl stop v2ray

package compile-tools

v2ray_version=4.32.0
arch=linux-64

mkdir -p /usr/bin/v2ray
download_and_extract https://github.com/v2fly/v2ray-core/releases/download/v${v2ray_version}/v2ray-${arch}.zip v2ray-v${v2ray_version}
cd v2ray-v${v2ray_version} && rm *.sig && chmod +x v2ctl* v2ray*

v2ray_commands=$(find -maxdepth 1 -name 'v2ray_*')

for v2ray_command in ./v2ray $v2ray_commands; do
    if $v2ray_command -version &>/dev/null; then
        valid_v2ray_command=$v2ray_command
        valid_v2ctl_command=$(echo $v2ray_command |sed 's#v2ray#v2ctl#')
        break
    else
        valid_v2ray_command=
    fi
done

if [  -z "$valid_v2ray_command" ]; then
    echo 'Not valid v2ray version is supported by current router, please check if download correct version.'
    exit
else
    $valid_v2ray_command -version
fi && cp v2ray v2ctl *.dat /usr/bin/v2ray &&
    cp systemd/v2ray.service /etc/systemd/system

uuid=$(uuidgen)

replace_string 'NEWUUID' "${uuid}" /etc/v2ray/config.json

cat <<'HEREDOC' >> /etc/sysctl.conf
fs.file-max=51200

net.core.rmem_max=67108864
net.core.wmem_max=67108864
net.core.netdev_max_backlog=250000
net.core.somaxconn=4096

net.ipv4.tcp_syncookies=1
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_fin_timeout=30
net.ipv4.tcp_keepalive_time=1200
net.ipv4.ip_local_port_range=10000 65000
net.ipv4.tcp_max_syn_backlog=8192
net.ipv4.tcp_max_tw_buckets=5000
net.ipv4.tcp_mem=25600 51200 102400
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864
net.ipv4.tcp_mtu_probing=1

# å¼€å¯å†…æ ¸ fastopen, Linux 3.7 ä»¥ä¸Šæ”¯æŒ, 3.13 æ‰é»˜è®¤å¼€å¯.
# ç­‰ä»·äº echo 3 > /proc/sys/net/ipv4/tcp_fastopen
net.ipv4.tcp_fastopen=3
HEREDOC

if kernel_version_greater_than 4.9; then
    modprobe tcp_bbr && lsmod | grep bbr
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
fi

sysctl -p > /dev/null

# test bbr is enabled
sysctl net.ipv4.tcp_available_congestion_control |grep bbr
sysctl -n net.ipv4.tcp_congestion_control |grep bbr

mkdir -p /var/log/v2ray

systemctl enable v2ray
systemctl restart v2ray
systemctl status v2ray

# ä» server.json æ¥è·å–å¿…é¡»çš„ä¸€äº›ä¿¡æ¯.
v2ray_port=$(cat /etc/v2ray/config.json |grep '"inbounds"' -A10 |grep '"protocol" *: *"vmess"' -A3 |grep '"port"' |grep -o '[0-9]*')
ss_port=$(cat /etc/v2ray/config.json |grep '"inbounds"' -A100 |grep '"protocol" *: *"shadowsocks"' -A3 |grep '"port"' |grep -o '[0-9]*')
ss_encrypt_method=$(cat /etc/v2ray/config.json |grep '"inbounds"' -A100 |grep '"protocol" *: *"shadowsocks"' -A10 |grep '"method"'|cut -d':' -f2|cut -d'"' -f2)
ss_password=$(cat /etc/v2ray/config.json |grep '"inbounds"' -A100 |grep '"protocol" *: *"shadowsocks"' -A10 |grep '"password"'|cut -d':' -f2|cut -d'"' -f2)

expose_port $v2ray_port
expose_port $ss_port

set -u
cat <<HEREDOC > /etc/v2ray/v2ray.json
// æœ¬è„šæœ¬å½“è¿è¡Œ deploy_v2ray+ss_to_vps æ—¶è‡ªåŠ¨ç”Ÿæˆã€‚
// æœ¬è„šæœ¬å¯ä½œä¸º æ™®é€š v2ray client è„šæœ¬ï¼Œä¹Ÿå¯ä»¥ä½œä¸º ASUS merlin è·¯ç”±å™¨é€æ˜ä»£ç† v2ray è„šæœ¬ï¼Œ
// è¿è¡Œ ./v2ray+dnsmasq+dnscrypt2 admin@router.asus.com éƒ¨ç½²è¿™ä¸ªé…ç½®æ–‡ä»¶åˆ°è·¯ç”±å™¨ã€‚

{
    // "log": {
    //     "loglevel": "info"
    // },
    "dns": {
        "clientIp": "120.92.83.126",
        "hosts": {
            // "baidu.com": "127.0.0.1"
        },
        "servers": [
            {
                "address": "202.99.192.66",
                "port": 53,
                "domains": [
                    "geosite:cn"
                ],
                "expectIPs": [
                    "geoip:cn"
                ]
            },
            {
                "address": "8.8.4.4",
                "domains": [
                    "geosite:geolocation-!cn"
                ]
            },
            "114.114.114.114"
        ]
    },
    "routing": {
        // "domainStrategy": "IPIfNonMatch",
        // ä»‹ç»ä¸‹å®Œæ•´çš„ V2Ray æ•°æ®åŒ…æµç¨‹

        //    [å…¬å…±æ­¥éª¤]
        //    - æµè§ˆå™¨é’ˆå¯¹ dnsmasq 53 ç«¯å£å‘é€ www.ip111.cn çš„ DNS æŸ¥è¯¢ã€‚
        //    - dnsmasq forward æ‰€æœ‰ DNS æŸ¥è¯¢ V2Ray ç›‘å¬çš„æœ¬åœ° 65053.
        //    - è¿›å…¥ V2ray çš„ dns-inbound/dns-outbound, æ­¤æ—¶ DNS æŸ¥è¯¢è¢«è½¬å‘åˆ°
        //      8.8.4.4:53 ä¸Šå‡†å¤‡è¿›è¡ŒæŸ¥è¯¢, ä½†æ˜¯åœ¨é‚£ä¸ªä¹‹å‰ï¼Œ è¿˜æ˜¯ä¼šåœ¨ DNS çš„
        //      servers é…ç½®å½“ä¸­ï¼Œè¿›è¡Œä¸€æ¬¡åŒ¹é…ã€‚

        // é—®é¢˜ï¼š dns inbound é‡Œçš„è½¬å‘ï¼Œå’Œ outbound é‡Œé¢ ç›´æ¥ä¿®æ”¹ address/port,
        // ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

        //    [è®¿é—®å›½å†…ç½‘å€]
        //     ä»¥è®¿é—® www.ip111.cn ä¸ºä¾‹
        //    - é¦–å…ˆä¼šè¿›å…¥ DNS çš„ servers è®¾å®šè¿›è¡ŒåŒ¹é….
        //    - servers åŒ¹é…ä¸­ï¼Œ æŒ‰ç…§åŸŸå(www.ip111.cn)åŒ¹é…å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§,
        //      å…¶æ¬¡ï¼Œæ‰æ˜¯æŒ‰é¡ºåºä»ä¸Šå¾€ä¸‹æ‰¾ï¼Œ è¿™é‡Œ, è¿™é‡Œå®ƒåŒ¹é… geosite:cn
        //      ä»¥åŠ geoip:cn, å› æ­¤ï¼Œä½¿ç”¨ 114.114.114.114 æŸ¥è¯¢.
        //    - ä½†æ˜¯ä»ç„¶éœ€è¦ç¡®å®šä½¿ç”¨ä»€ä¹ˆçº¿è·¯ä» 114.114.114.114:53 æ¥è·å–åŸŸååœ°å€,
        //      æ­¤æ—¶è¿›å…¥ routing æŸ¥è¯¢ï¼Œ å› ä¸ºåŒ¹é…åˆ° geoip:cn, èµ° direct.
        //    - èµ°ç³»ç»ŸéåŠ å¯†ç›´è¿ï¼Œå‘ 114.114.114.114 è§£æåŸŸåï¼Œå¹¶å»ºç«‹è¿æ¥.
        //    - é€šä¿¡å®Œæˆ.

        //    [è®¿é—®å›½å¤–ç½‘å€]
        //    ä»¥è®¿é—® google.com ä¸ºä¾‹
        //    - é¦–å…ˆä¼šè¿›å…¥ DNS çš„ servers è®¾å®šè¿›è¡ŒåŒ¹é….
        //    - google.com åŒ¹é…ç¬¬äºŒæ¡: geosite:geolocation-!cn, ä½¿ç”¨ 8.8.4.4:53 æŸ¥è¯¢.
        //    - ç¬¬ä¸€æ¬¡è¿› routing æŸ¥è¯¢:
        //      ä½†æ˜¯ä»ç„¶éœ€è¦ç¡®å®šä½¿ç”¨ä»€ä¹ˆçº¿è·¯ä» 8.8.4.4:53 æ¥è·å–åŸŸåçš„åœ°å€
        //      å› æ­¤ï¼Œè¿›å…¥ routing æŸ¥è¯¢, å› ä¸ºåŒ¹é…åˆ° 8.8.4.4, èµ° proxy.
        //    - å› ä¸º google.com ä¸åŒ¹é…ä»»ä½• routing æ¡ç›®ï¼Œæµé‡é»˜è®¤ç”±ä¸»å‡ºç«™åè®®å‘å‡ºã€‚
        //      å³: outbounds é‡Œé¢çš„ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼Œåœ¨è¿™é‡Œæ˜¯ proxy.
        //    - å»ºç«‹è¿æ¥ï¼Œå¼€å§‹é€šä¿¡ï¼Œå®Œæˆ.

        // https://medium.com/@TachyonDevel/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0
        "rules": [
            {
                "type": "field",
                "domain": [
                    "geosite:cn"
                ],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": [
                    "geoip:cn"
                ],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "inboundTag": "dns-inbound",
                "outboundTag": "dns-outbound"
            },
            {
                "type": "field",
                "ip": [
                    "8.8.4.4"
                ],
                "outboundTag": "proxy"
            },
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads"
                ],
                "outboundTag": "block"
            },
            {
                "type": "field",
                "protocol":[
                    "bittorrent"
                ],
                "outboundTag": "direct"
            }
        ]
    },
    "inbounds": [
        {
            "protocol": "dokodemo-door",
            "port": 1081, // ç›‘å¬ç«¯å£
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            },
            "settings": {
                "network": "tcp,udp",
                "followRedirect": true // è¿™é‡Œè¦ä¸º true æ‰èƒ½æ¥å—æ¥è‡ª iptables çš„æµé‡
            }
        },
        {
            "tag": "dns-inbound",
            "protocol": "dokodemo-door",
            "port": 65053,
            "settings": {
                "address": "8.8.4.4",
                "port": 53,
                "network": "tcp,udp"
            }
        },
        {
            "protocol": "socks", // å…¥å£åè®®ä¸º SOCKS 5
            "port": 1080, // ç›‘å¬ç«¯å£
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            },
            "settings": {
                "auth": "noauth"  //socksçš„è®¤è¯è®¾ç½®ï¼Œnoauth ä»£è¡¨ä¸è®¤è¯ï¼Œç”±äº socks é€šå¸¸åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä¸è®¤è¯
            }
        },
        {
            "protocol": "http",
            "port": 3128,
            "settings": {
                "timeout": 0
            }
        }
    ],
    "outbounds": [
        // ä¸‹é¢ä¸¤ä¸ªé¡ºåºä¸å¯ä»¥é¢ å€’, å› ä¸ºåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºä¸»å‡ºç«™åè®®, å½“è·¯ç”±åŒ¹é…ä¸å­˜åœ¨æˆ–æ²¡æœ‰åŒ¹é…æˆåŠŸæ—¶ï¼Œ
        // æµé‡ç”±ä¸»å‡ºç«™åè®®å‘å‡º, æˆ‘ä»¬è¦ç¡®ä¿ä¸»å‡ºç«™åè®®å¿…é¡»æ˜¯ proxy.
        {
            "tag": "proxy",
            "protocol": "vmess", // å‡ºå£åè®®
            "settings": {
                "vnext": [
                    {
                        "address": "$targetip", // æœåŠ¡å™¨åœ°å€ï¼Œè¯·ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„æœåŠ¡å™¨ IP æˆ–åŸŸå
                        "port": $v2ray_port,  // æœåŠ¡å™¨ç«¯å£
                        "users": [
                            {
                                "id": "$uuid",  // ç”¨æˆ· IDï¼Œå¿…é¡»ä¸æœåŠ¡å™¨ç«¯é…ç½®ç›¸åŒ
                                "alterId": 4 // æ­¤å¤„çš„å€¼ä¹Ÿåº”å½“ä¸æœåŠ¡å™¨ç›¸åŒ
                            }
                        ]
                    }
                ],
                // é»˜è®¤æ˜¯ AsIs, ä¸ä¼šä½¿ç”¨ V2ray å†…ç½®çš„ DNS æœåŠ¡å™¨è¿›è¡Œè§£æ,
                // æ”¹ä¸º UseIP, è¡¨ç¤ºä½¿ç”¨ V2ray å†…ç½® DNS æœåŠ¡å™¨å°†åŸŸåè§£æä¸º IP ä¹‹åå†å»ºç«‹è¿æ¥ã€‚
                "domainStrategy": "UseIP"
            },
            "streamSettings": {
                "network": "quic",  // é»˜è®¤å€¼æ˜¯ tcp
                "quicSettings": {
                    "header": {
                        "type": "wechat-video"
                    }
                },
                "sockopt": {
                    "tproxy": "redirect",
                    "mark": 255
                }
            },
            "mux": {"enabled": true}
        },
        {
            "protocol": "shadowsocks",
            "settings": {
                "servers": [
                    {
                        "address": "$targetip", // Shadowsocks çš„æœåŠ¡å™¨åœ°å€
                        "method": "$ss_encrypt_method", // Shadowsocks çš„åŠ å¯†æ–¹å¼
                        "password": "$ss_password", // Shadowsocks çš„å¯†ç 
                        "port": $ss_port
                    }
                ]
            }
        },
        {
            // è¿™ä¸ª dns-outbound å­˜åœ¨çš„å”¯ä¸€ç›®çš„æ˜¯:
            // è¯†åˆ«è¿™æ˜¯ä¸€ä¸ª DNS è¯·æ±‚ï¼Œ å¹¶å‘é€åˆ°å†…éƒ¨ DNS è¿›è¡ŒæŸ¥è¯¢.
            "tag": "dns-outbound",
            "protocol": "dns",
            "proxySettings": {
                "tag": "proxy"
            }
        },
        {
            "tag": "direct",
            "protocol": "freedom",
            "streamSettings": {
                "network": "tcp",  // è¿™æ˜¯é»˜è®¤å€¼
                "sockopt": {
                    "mark": 255
                }
            }
        },
        {
            "tag": "block",
            "protocol": "blackhole",
            "settings": {
                "response": {
                    "type": "http"
                }
            }
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "bufferSize": 4
            }
        }
    }
}
HEREDOC

echo "Your's shadowsocks port: [0m[33m${ss_port}[0m"
echo "Your's shadowsocks encrypt method: [0m[33m${ss_encrypt_method}[0m"
echo "Your's shadowsocks password: [0m[33m${ss_password}[0m"
echo 'Congratulations, Deploy succssful!'
