#!/bin/bash

self="$(\curl -sS https://gitlab.com/zw963/deployment_bash/-/raw/v0.8.7/deploy_start.sh)" && eval "$self"

export_variable target=$1
export_variable arch=${router_arch-linux-amd64}

echo "Set \$router_arch env to e.g. \`linux-arm32-v5' for deploy Xray into ASUS AC5300 router.
For the correct Arch name, check https://github.com/XTLS/Xray-core/releases assets.
Current arch using: ${arch}"

config_folder=./downloaded_binary/${arch}
config=${config_folder}/v2ray.json

if [ ! -f "$config" ];then
    echo "Please create ${config} or generate it use ./deploy_server root@some_ip before deploy to side router."
    exit 1
fi

assets=(geoip.dat geosite.dat geoip-only-cn-private.dat v2ray xray)

for i in "${assets[@]}"; do
    if [ ! -f "${config_folder}/$i" ];then
        echo "${config_folder}/$i is missing, predownload it use ./deploy_server root@some_ip before deploy to router."
        exit 1
    fi
done

echo 'Copy downloaded binary to router ...'
copy $config_folder downloaded_binary

if cat $config |grep -qs '"protocol": "vless"'; then
    service_name=xray
else
    service_name=v2ray
fi

if [ "$use_xtls" ]; then
    export_variable service_name=xray
else
    export_variable service_name=${service_name}
fi

echo "Set \$use_xtls=true if prefer deploy Xray instead of V2ray.
Current auto-detect: ${service_name}.
"

function postinstall () {
    set -u
    echo
    echo 'Please waiting for 10 seconds to check google available ...'
    sleep 10
    check_google=$(curl -so /dev/null -w 'Google: %{http_code}\n' google.com)
    if [[ "$check_google" =~ 301|200 ]]; then
        echo "visit google successful, Your's ip is: $(curl http://ipecho.net/plain; echo)"
    else
        echo 'visit google failed, something was wrong!'
    fi
}

ssh "$*" "sudo mkdir -p /opt/etc /opt/sbin /var/log/v2ray"
copy router/opt/etc/apply_iptables_rule.sh /opt/etc/
copy router/opt/etc/clean_iptables_rule.sh /opt/etc
copy router/opt/etc/update_geodata.sh /opt/etc
copy router/opt/etc/toggle_proxy.sh /opt/etc
copy router/opt/etc/patch_router /opt/etc
copy router/opt/etc/iptables-rule.service /etc/systemd/system
copy router/opt/etc/check_google_use_proxy.sh /opt/etc
copy router/opt/etc/check_google_use_socks5.sh /opt/etc
copy router/opt/etc/debug_v2ray.sh /opt/etc

deploy_start

set -eu

# --------------------------------------------------------------------------------
#
# Following script will be run on router, please change it to meet your's need.
#
# -------------------------------------------------------------------------------

#
# å¦‚æžœç¬¬ä¸€æ¬¡è¿è¡Œæœ¬è„šæœ¬, è¯·åŠ¡å¿…æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

# 1. è½¯è·¯ç”±è®¾å®šä½¿ç”¨å›ºå®š IP,
# 2. è½¯è·¯ç”±å°† gateway ä»¥åŠ dns1 æŒ‡å®šåˆ°ä½ çš„ä¸»è·¯ç”±(WiFi è·¯ç”±å™¨) IP.
# 3. ä»¥ä¸Šè®¾å®šå®ŒåŽï¼Œåœ¨ä¸»è·¯ç”±é€šè¿‡(è·¯ç”±å™¨çš„) web ç•Œé¢ï¼Œå°†ç½‘å…³(gateway)ä»¥åŠç¬¬ä¸€ä¸ª dns(dns1)
#    è½¯è·¯ç”± IP åœ°å€.

# ä»¥ centos 7 ä¸ºä¾‹ï¼Œéœ€è¦é’ˆå¯¹ /etc/sysconfig/network-scripts/ifcfg-enp0s25
# åšå¦‚ä¸‹æ›´æ”¹ï¼š(enp0s25 ä¸ºç½‘å¡ interface)
# - ä¿®æ”¹ BOOTPROTO=none
# - è®¾å®š IPADDR=192.168.50.111 (åŒç½‘æ®µä»»æ„å›ºå®š IP)
# - è®¾å®š GATEWAY=192.168.50.1 (ä¸»è·¯ç”±å™¨ IP)
# - è®¾å®š DNS1=192.168.50.1 (ä¸»è·¯ç”± IP)
# - è®¾å®š PREFIX=24 (ç”¨æ¥åˆå§‹åŒ– netmask ç­‰)
# - for centos 7, systemctl restart network OR
#    for centos 8, nmcli connection down enp0s25 && sudo nmcli connection up enp0s25
# - å…³é—­ firewalld, å› ä¸ºå®ƒå¯èƒ½ä¼šé€ æˆ iptables-rule.service åœ¨å¯åŠ¨æ—¶å¤±è´¥ã€‚

# æœ€åŽï¼Œå¯é€‰çš„ï¼Œæ‰“å¼€ /etc/systemd/logind.conf, ä¿®æ”¹ä¸ºå¦‚ä¸‹è®¾ç½®ï¼Œæ¥é¿å…å…³é—­ç›–å­å¾…æœºã€‚
# [Login]
# HandleLidSwitch=ignore
# HandleLidSwitchDocked=ignore

# è¿˜éœ€è¦é˜»æ­¢è‡ªåŠ¨ suspend, ä»¥åŠ hibernate.(å–æ¶ˆä½¿ç”¨ unmask æ›¿æ¢ mask)
# $ systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

cd downloaded_binary

if ! ./$service_name version &>/dev/null; then
    echo "Invalid $service version/arch supported by current side router, please download correct version."
    exit
fi

set +e
systemctl stop v2ray
set -e

cp $service_name geosite.dat geoip-only-cn-private.dat /opt/sbin/
cp v2ray.json /opt/etc

cp systemd/system/*.service /etc/systemd/system
replace_regex1 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray.service
replace_regex1 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray@.service
replace_string1 '/usr/local/bin/v2ray -config /usr/local/etc/v2ray/config.json' '/opt/sbin/xray run -config /opt/etc/v2ray.json' /etc/systemd/system/v2ray.service
replace_string1 '/usr/local/bin/v2ray -config /usr/local/etc/v2ray/%i.json' '/opt/sbin/xray run -config /opt/etc/%i.json' /etc/systemd/system/v2ray@.service
systemctl daemon-reload

echo 'xray is installed'

# ----------------------------------------------------
#
# ä¸‹é¢æ‰§è¡Œä¸€äº›è„šæœ¬æ£€æŸ¥ä¸Žæ›¿æ¢ã€‚
#
# ---------------------------------------------------

cd /opt/etc
chmod +x apply_iptables_rule.sh \
      clean_iptables_rule.sh \
      update_geodata.sh \
      toggle_proxy.sh \
      patch_router \
      check_google_use_proxy.sh \
      check_google_use_socks5.sh \
      debug_v2ray.sh

# é»˜è®¤é…ç½®æ–‡ä»¶é€‚ç”¨äºŽè·¯ç”±å™¨é…åˆ dnsmasq ä¸€èµ·ä½¿ç”¨ï¼Œä½¿ç”¨æ—è·¯ç”±æ—¶ï¼Œç›´æŽ¥åœ¨ 53 ç«¯å£ç›‘å¬å³å¯ã€‚
replace_string '65053' '53' /opt/etc/v2ray.json

/opt/etc/clean_iptables_rule.sh && chmod -x /opt/etc/apply_iptables_rule.sh
chmod +x /opt/etc/apply_iptables_rule.sh && /opt/etc/apply_iptables_rule.sh

# ----------------------------------------------------
#
# å¯åŠ¨æ‰€éœ€çš„è„šæœ¬
#
# ---------------------------------------------------

set +e
systemctl disable firewalld &>/dev/null
systemctl stop firewalld &>/dev/null
set -e

systemctl daemon-reload && systemctl start v2ray && systemctl enable v2ray && systemctl status v2ray
systemctl start iptables-rule &&  systemctl enable iptables-rule
cp /opt/etc/update_geodata.sh /etc/cron.weekly/

config_sysctl_for_proxy

/opt/etc/patch_router && echo "Congratulations, [0m[33mDeploy succssful[0m!"
