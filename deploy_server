#!/bin/sh

self="$(\curl -sS https://gitlab.com/zw963/deployment_bash/-/raw/v0.8.10/deploy_start.sh)" && eval "$self"
# self="$(cat /home/common/Project/deployment_bash/deploy_start.sh)" && eval "$self"

export_variable use_xtls="${use_xtls-true}"

if [ "$use_xtls" == "true" ]; then
    export_variable service_name=xray
    export_variable another_service_name=v2ray
else
    export_variable service_name=v2ray
    export_variable another_service_name=xray
fi

export_variable target=$1
export_variable old_uuid=$(ssh $target cat /etc/${service_name}/config.json 2>/dev/null |grep '"flow": "xtls-rprx' -A5 -B5 |grep '"id":' |cut -d: -f2 |cut -d'"' -f2)
export_variable old_port=$(ssh $target cat /etc/${service_name}/config.json 2>/dev/null |grep -A3 -B3 '"protocol":\s*"vless\|vmess"' |grep port |grep -o '[0-9]*')
export_variable old_reality_domain_name=$(ssh $target cat /etc/${service_name}/config.json 2>/dev/null |grep '"dest":' |cut -d':' -f2- |cut -d'"' -f2)
export_variable old_reality_private_key=$(ssh $target cat /etc/${service_name}/config.json 2>/dev/null |grep '"privateKey":' |cut -d: -f2- |cut -d'"' -f2)
export_variable old_ss_port=$(ssh $target cat /etc/${service_name}/config.json |grep '"protocol": "shadowsocks"' -A3 |grep port |grep -o '[0-9]*')
export_variable old_ss_method=$(ssh $target cat /etc/${service_name}/config.json |grep '"protocol": "shadowsocks"' -A5 |grep method |cut -d: -f2 |sed -e 's#.*"\(.*\)".*#\1#')
export_variable old_ss_password=$(ssh $target cat /etc/${service_name}/config.json |grep '"protocol": "shadowsocks"' -A5 |grep password |cut -d: -f2 |sed -e 's#.*"\(.*\)".*#\1#')
export_variable arch=${router_arch-linux-arm32-v5}

cat <<HEREDOC
Set \$router_arch env to e.g. \`linux-arm32-v5/' if you want deploy to an asuswrt merlin AC5300 router.
For the correct Arch name, check https://github.com/XTLS/Xray-core/releases assets.
The default arch will assume server and side router use linux-amd64, and router using ${arch}.

HEREDOC

function postinstall () {
    set -u
    mkdir -p ./downloaded_binary/linux-amd64/services ./downloaded_binary/${arch}
    echo
    echo 'Please wait copy generated client config into local machine ...'
    scp  $target:/etc/$service_name/client_config.json ./downloaded_binary/linux-amd64/client_config.json
    scp  $target:/usr/local/bin/{geoip-only-cn-private.dat,geoip.dat,geosite.dat,xray,v2ray} ./downloaded_binary/linux-amd64/
    scp  $target:/etc/systemd/system/{v2ray.service,v2ray@.service} ./downloaded_binary/linux-amd64/services/
    cp router/opt/etc/{apply_iptables_rule.sh,clean_iptables_rule.sh,update_geodata.sh} ./downloaded_binary/linux-amd64/

    (
        cd ./downloaded_binary/linux-amd64/
        chmod +x apply_iptables_rule.sh clean_iptables_rule.sh update_geodata.sh xray v2ray
    )

    cp ./downloaded_binary/linux-amd64/{geoip-only-cn-private.dat,geoip.dat,geosite.dat,config.json} ./downloaded_binary/${arch}/
    scp  $target:/tmp/v2ray-clients/{xray,v2ray} ./downloaded_binary/${arch}/

    echo "Run [0m[33m./deploy_router admin@router_ip[0m to deploy to router."
    echo "Run [0m[33m./deploy_side_router root@side_router_ip[0m to deploy to side_router."
}

# if grep -qs -e 'change_yours_password_here' ${service_name}_server.json; then
#     echo "$service_name served as a shadowsocks server too."
#     echo "You must change \`[0m[33mchange_yours_password_here[0m' to a NEW password in \`./${service_name}_server.json'!"
#     exit
# fi

# password=$(cat ${service_name}_server.json |grep '"password"' |cut -d':' -f2 |cut -d'"' -f2)
# sed -i "s#change_yours_password_here#${password}#" "${another_service_name}_server.json"


ssh $target "[ -e /etc/${service_name}/config.json ] && cp -a /etc/${service_name}/config.json /etc/${service_name}/config.json.$(date '+%Y-%m-%d_%H:%M:%S')"
copy ${service_name}_server.json /etc/${service_name}/config.json

if [ "${service_name}" == xray ]; then
    copy downloaded_binary/linux-amd64/services/xray.service /etc/systemd/system/xray.service
    copy downloaded_binary/linux-amd64/services/xray@.service /etc/systemd/system/xray@.service
fi

deploy_start

set -eu

# --------------------------------------------------------------------------------
#
# Following script will be run on remote VPS, please change it to meet your's need.
#
# -------------------------------------------------------------------------------

# wget https://install.direct/go.sh
# bash go.sh

if [ -f /etc/systemd/system/$service_name.service ]; then
    set +e
    systemctl stop $service_name
    systemctl stop $another_service_name
    systemctl disable $another_service_name
    systemctl daemon-reload
    set -e
fi

xray_version=$(github_latest_release XTLS/Xray-core)
v2ray_version=$(github_latest_release v2fly/v2ray-core)

set -e

(
    download_and_extract https://github.com/XTLS/Xray-core/releases/download/${xray_version}/Xray-linux-64.zip Xray-${xray_version}-linux-64

    cd Xray-${xray_version}-linux-64 && chmod +x xray

    if ! ./xray version &>/dev/null; then
        echo 'Invalid xray version/arch, please download correct version.'
        exit
    fi

    cp xray *.dat /usr/local/bin
)

(
    download_and_extract https://github.com/XTLS/Xray-core/releases/download/${xray_version}/Xray-${arch}.zip Xray-${xray_version}-${arch}

    mkdir -p /tmp/v2ray-clients
    cd Xray-${xray_version}-${arch} && cp xray *.dat /tmp/v2ray-clients
)

(
    download_and_extract https://github.com/v2fly/v2ray-core/releases/download/${v2ray_version}/v2ray-linux-64.zip v2ray-${v2ray_version}-linux-64

    cd v2ray-${v2ray_version}-linux-64 && chmod +x v2ray

    if ! ./v2ray version &>/dev/null; then
        echo 'Invalid v2ray version/arch, please download correct version.'
        exit
    fi

    cp v2ray *.dat /usr/local/bin &&
        cp systemd/system/*.service /etc/systemd/system
)

(
    download_and_extract https://github.com/v2fly/v2ray-core/releases/download/${v2ray_version}/v2ray-${arch}.zip v2ray-${v2ray_version}-${arch}

    mkdir -p /tmp/v2ray-clients
    cd v2ray-${v2ray_version}-${arch} && cp v2ray *.dat /tmp/v2ray-clients
)

replace_regex 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray.service
replace_regex 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray@.service
replace_regex '/usr/local/etc/v2ray/config.json' '/etc/v2ray/config.json' /etc/systemd/system/v2ray.service
replace_regex '/usr/local/etc/v2ray/%i.json' '/etc/v2ray/%i.json' /etc/systemd/system/v2ray@.service

mkdir -p /var/log/xray /var/log/v2ray
# chown nobody:nobody /var/log/xray /var/log/v2ray

if [ "$old_uuid" != NEWUUID ]; then
    echo "Old uuid $old_uuid exists, use it."
    uuid=$old_uuid
else
    uuid=$(cat /proc/sys/kernel/random/uuid)
fi

replace_string 'NEWUUID' "${uuid}" /etc/${service_name}/config.json

# quic_key=$(uuidgen | sed 's/[-]//g' | head -c 20)

if [ -n "$old_port" ]; then
    replace_multiline1 '("protocal":\s*"vless",.*?)"port":\s*[0-9]*,' '$1"port":'" ${old_port}" /etc/${service_name}/config.json
    v2ray_port=$old_port
else
    v2ray_port=$(cat /etc/$service_name/config.json |grep '"inbounds"' -A10 |grep '"protocol" *: *"\(vmess\|vless\)"' -A3 |grep '"port"' |grep -o '[0-9]*')
fi

if [ -n "$old_ss_port" ]; then
    replace_multiline1 '("protocol": "shadowsocks",.*"port": )\d+' '${1}'"${old_ss_port}" /etc/${service_name}/config.json
    ss_port=$old_ss_port
else
    ss_port=$(cat /etc/${service_name}/config.json 2>/dev/null |grep -A3 -B3 '"protocol":\s*"vless\|vmess"' |grep port |grep -o '[0-9]*')
fi

if [ -n "$old_ss_method" ]; then
    replace_regex1 '"method": ".*"' "\"method\": \"${old_ss_method}\"" /etc/${service_name}/config.json
    ss_method=$old_ss_method
else
    ss_method=$(cat /etc/${service_name}/config.json |grep '"protocol": "shadowsocks"' -A5 |grep method |cut -d: -f2 |sed -e 's#.*"\(.*\)".*#\1#')
fi

if [[ -n "$old_ss_password" ]] && [[ "$old_ss_password" != "SSPASS" ]]; then
    replace_regex1 '"password": ".*"' "\"password\": \"${old_ss_password}\"" /etc/${service_name}/config.json
    ss_password=$old_ss_password
else
    # ç”Ÿæˆçš„å¯†é’¥é•¿åº¦ä¸ 2022-blake3-chacha20-poly1305 2022-blake3-aes-256-gcm å…¼å®¹
    ss_password=$(openssl rand -base64 32)
fi

config_sysctl_for_proxy

systemctl enable $service_name

if [ "$use_xtls" == "true" ]; then
    if [ -z "$old_reality_domain_name" ]; then
        # ä½¿ç”¨ xray_server.json ä¸­çš„é»˜è®¤é…ç½®ï¼Œå³: www.hko.gov.hk:443
        # è¿˜å¯ä»¥é€‰æ‹©é¦™æ¸¯è¿è¾“ç½² www.td.gov.hk
        # éŸ©å›½æ¨è freegame.gg
        # è¦æ±‚: 1. HTTP/2+ 2. TLS 1.3+
        reality_domain_name=$(cat /etc/${service_name}/config.json |grep '"dest":' |cut -d':' -f2- |cut -d'"' -f2)
        client_server_name=$(echo ${reality_domain_name} |cut -d: -f1)

        echo "reality domain name use ${reality_domain_name}"
    else
        # ä½¿ç”¨ä¸Šæ¬¡éƒ¨ç½²çš„é…ç½®
        reality_domain_name=$old_reality_domain_name
        client_server_name=$(echo ${reality_domain_name} |cut -d: -f1)

        echo "Using exists reality domain name ${old_reality_domain_name}..."

        replace_regex1 '"dest": ".*"' "\"dest\": \"${reality_domain_name}\"" /etc/${service_name}/config.json
        replace_regex '"serverNames": \[".*"\]' "\"serverNames\": [\"${client_server_name}\"]" /etc/${service_name}/config.json
    fi

    if [ -n "$old_reality_private_key" ] && [[ "$old_reality_private_key" != "REALITY_PRIVATE_KEY_HERE" ]]; then
        echo "Use exists x25519 key pairs ..."

        reality_private_key=$old_reality_private_key
        reality_public_key=$(/usr/local/bin/xray x25519 -i $reality_private_key |tail -n1 |cut -d: -f2 |cut -d' ' -f2)
    else
        # é‡æ–°ç”Ÿæˆ
        echo "Geneate new x25519 key pairs ..."

        key_pairs=$(/usr/local/bin/xray x25519)
        reality_private_key=$(echo "$key_pairs" |head -n1 |cut -d: -f2 |cut -d' ' -f2)
        reality_public_key=$(echo "$key_pairs" |tail -n1 |cut -d: -f2 |cut -d' ' -f2)
    fi


    replace_string 'REALITY_PRIVATE_KEY_HERE' "$reality_private_key" /etc/${service_name}/config.json
fi

# geoip_version=$(github_latest_release v2fly/geoip)
# wget https://github.com/v2fly/geoip/releases/download/${geoip_version}/geoip-only-cn-private.dat -o geoip-only-cn-private.dat

systemctl restart $service_name
systemctl status $service_name
systemctl enable $service_name

expose_port $v2ray_port
expose_port $ss_port

set -u
cat <<HEREDOC > /etc/$service_name/client_config.json
// æœ¬è„šæœ¬å½“è¿è¡Œ deploy_server æ—¶è‡ªåŠ¨ç”Ÿæˆã€‚
// æœ¬è„šæœ¬å¯ä½œä¸º æ™®é€š v2ray å®¢æˆ·ç«¯è„šæœ¬ï¼Œä¹Ÿå¯ä»¥ä½œä¸º ASUS æ¢…æ—è·¯ç”±å™¨/æ—è·¯ç”± é€æ˜ä»£ç†è„šæœ¬ï¼Œ
// è¿è¡Œ ./deploy_router admin@router.asus.com éƒ¨ç½²è¿™ä¸ªé…ç½®æ–‡ä»¶åˆ°è·¯ç”±å™¨ã€‚
// è¿è¡Œ ./deploy_side_router root@one_ip éƒ¨ç½²è¿™ä¸ªé…ç½®æ–‡ä»¶åˆ°æ—è·¯ç”±ã€‚
{
    "log": {
        "loglevel": "warning"
    },
    "dns": {
        "hosts": {
            "geosite:category-ads-all": "127.0.0.1"
        },
        "servers": [
            // V2Ray ä¼šä½¿ç”¨ DNS over HTTPS (RFC8484, ç®€ç§°DOH) è¿›è¡ŒæŸ¥è¯¢ã€‚
            // DoH é»˜è®¤èµ°ç¬¬ä¸€ä¸ª outbound æ¥æŸ¥è¯¢ ï¼ˆDoH åŸŸåéœ€è¦åœ¨ hosts ä¸­æŒ‡å®š IP åœ°å€ï¼‰
            "8.8.4.4",
	    "1.1.1.1",
            {
                // 180.76.76.76 æ˜¯ç™¾åº¦çš„ DNSï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºå½“åœ°è¿è¥å•†çš„
                // è¿™é‡Œä¹‹å‰æ˜¯ localhost, é€ æˆäº†æ­»å¾ªç¯ï¼Œä¸¥é‡å½±å“è®¿é—®å›½å†…ç½‘ç«™çš„æ€§èƒ½ã€‚
                "address": "180.76.76.76",
                "port": 53,
                "domains": [
                    "geosite:cn"
                ],
                "expectIPs": [
                    "ext:geoip-only-cn-private.dat:cn"
                ]
            },
            {
                "address": "8.8.4.4",
                "port": 53,
                "domains": [
                    "services.googleapis.cn",
                    "googleapis.com",
                    "gstatic.com",
                    "xn--ngstr-lra8j.com",
                    "googleusercontent.com"
                ]
            },
            {
                // fakeDNS å¿…é¡»ï¼Œå¦åˆ™ä¼šè¢«è§£æä¸º fake IP.
                // æ³¨æ„ï¼ŒæŸäº›è§†é¢‘ç½‘ç«™è§†é¢‘æ— æ³•æ’­æ”¾ï¼Œè²Œä¼¼å°±æ˜¯å› ä¸ºè®¿é—®ç½‘ç«™æ—¶ï¼Œ
                // è§£æåˆ°é”™è¯¯çš„ IP åœ°å€ã€‚
                "address": "180.76.76.76",
                "port": 53,
                "domains": [
                    "router.asus.com",
                    "arch.pool.ntp.org",
                    "dl.google.com",
                    "sourceforge.net",
                    "380tv.com",
                    "vidhub.tv",
                    "staticfile.org",
                    "www.naifei.im",
                    "crystal-lang.org",
                    "yzzy-online.com",
                    "cjkypo.com",
                    "gitlab.com",
                    "fonts.gstatic.com",
                    "fonts.googleapis.com",
                    "scootersoftware.com",
                    "archlinux.org",
                    "woaimoon.net",
		    "bing.com"
                ]
            }
        ],
        // é»˜è®¤ä¸º false, å¼€å¯åï¼Œå¦‚æœé€šè¿‡é»˜è®¤çš„ DNS è®¿é—®è¿”å›ç»“æœä¸åŒ¹é… cn site/ip,
        // å°†ä½¿ç”¨ servers é‡Œé¢çš„ç¬¬ä¸€ä¸ªï¼Œ8.8.4.4 è®¿é—®ã€‚
        "disableFallback": true
    },
    "routing": {
        "rules": [
            {
                // tproxy é€æ˜ä»£ç†å¿…éœ€ã€‚
                "type": "field",
                "inboundTag": ["transparent"],
                "port": 53,
                "network": "udp",
                "outboundTag": "dns-outbound"
            },
            {
                "type": "field",
                "domain": [
                    // è¿™é‡Œæ·»åŠ åŸŸåç™½åå•.
                    "geosite:cn",
                    "router.asus.com",
                    "arch.pool.ntp.org",
                    "dl.google.com",
                    "sourceforge.net",
                    "380tv.com",
                    "vidhub.tv",
                    "staticfile.org",
                    "www.naifei.im",
                    "crystal-lang.org",
                    "yzzy-online.com",
                    "cjkypo.com",
                    "gitlab.com",
                    "fonts.gstatic.com",
                    "fonts.googleapis.com",
                    "scootersoftware.com",
                    "archlinux.org",
                    "woaimoon.net",
		    "bing.com"
                ],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": ["180.76.76.76"],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": [
                    "ext:geoip-only-cn-private.dat:cn",
                    "ext:geoip-only-cn-private.dat:private"
                ],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "inboundTag": ["transparent"],
                "port": "123,323",
                "network": "udp",
                "outboundTag": "direct"
            },
            { // BT æµé‡ç›´è¿
                "type": "field",
                "protocol":["bittorrent"],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": ["8.8.4.4"],
                "outboundTag": "proxy"
            },
            {
                "type": "field",
                "domain": [
                    // è¿™é‡Œæ·»åŠ å¿…é¡»èµ° proxy çš„åŸŸåä¾‹å¤–.
                    // "services.googleapis.cn",
                    "raw.githubusercontent.com",
                    "github.githubassets.com",
                    "services.googleapis.cn",
                    "googleapis.com",
                    "xn--ngstr-lra8j.com"
                ],
                "outboundTag": "proxy"
            },
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "tag": "transparent",
            "protocol": "dokodemo-door",
            "port": 1081, // é€æ˜ä»£ç† 1081 ç«¯å£
            "settings": {
                "network": "tcp,udp",
                // å½“å€¼ä¸º true æ—¶ï¼Œdokodemo-door ä¼šè¯†åˆ«å‡ºç”± iptables è½¬å‘è€Œæ¥çš„æ•°æ®ï¼Œå¹¶è½¬å‘åˆ°ç›¸åº”çš„ç›®æ ‡åœ°å€ã€‚è¯¦è§ ä¼ è¾“é…ç½® ä¸­çš„ tproxy è®¾ç½®ã€‚
                "followRedirect": true
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls"]
            },
            "streamSettings": {
                "sockopt": {
                    // å½“ Dokodemo-door ä¸­æŒ‡å®šäº† followRedirectï¼Œä¸” sockopt.tproxy ä¸ºç©ºæ—¶ï¼Œ
                    // sockopt.tproxy çš„å€¼ä¼šè¢«è®¾ä¸º "redirect"ï¼Œå› æ­¤è¯¥è®¾å®š redirect æ¨¡å¼éå¿…é¡»çš„ã€‚
                    // ä¸‹é¢çš„é€‰é¡¹ä¼šåœ¨ patch_router çš„æ—¶å€™ï¼Œè‡ªåŠ¨é€‰æ‹© tproxy/redirect, å¹¶è¢«æ›¿æ¢ã€‚
                    "tproxy": "tproxy",
                    "mark": 255
                }
            }
        },
        {
            "protocol": "socks", // å…¥å£åè®®ä¸º SOCKS 5
            "port": 1080, // ç›‘å¬ç«¯å£
            "settings": {
                "auth": "noauth"  //socksçš„è®¤è¯è®¾ç½®ï¼Œnoauth ä»£è¡¨ä¸è®¤è¯ï¼Œç”±äº socks é€šå¸¸åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä¸è®¤è¯
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls"]
            }
        },
        {
            "protocol": "http",
            "port": 3128,
            "settings": {
                "timeout": 0
            }
        }
    ],
    "outbounds": [
        // ä¸‹é¢ä¸¤ä¸ªé¡ºåºä¸å¯ä»¥é¢ å€’, å› ä¸ºåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºä¸»å‡ºç«™åè®®, å½“è·¯ç”±åŒ¹é…ä¸å­˜åœ¨æˆ–æ²¡æœ‰åŒ¹é…æˆåŠŸæ—¶ï¼Œ
        // æµé‡ç”±ä¸»å‡ºç«™åè®®å‘å‡º, æˆ‘ä»¬è¦ç¡®ä¿ä¸»å‡ºç«™åè®®å¿…é¡»æ˜¯ proxy.
        {
            "tag": "proxy",
            "protocol": "vless", // å‡ºå£åè®®
            "settings": {
                "vnext": [
                    {
                        "address": "$targetip", // æœåŠ¡å™¨åœ°å€ï¼Œè¯·ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„æœåŠ¡å™¨ IP æˆ–åŸŸå
                        "port": $v2ray_port,  // æœåŠ¡å™¨ç«¯å£
                        "users": [
                            {
                                // æ³¨æ„, vmess åŠ å¯†é»˜è®¤å¼€å¯, ä¹Ÿå¿…é¡»å¼€å¯, å¦åˆ™ä¸Šä¸äº†ç½‘.
                                // alterId é»˜è®¤ä¸º 0, è¡¨ç¤ºå¼€å¯ VMessAEAD.
                                // vless åˆ™é»˜è®¤å…³é—­åŠ å¯† noneï¼Œä½†å¿…é¡»æœ‰è¿™ä¸ªè®¾å®š
                                "encryption": "none",
                                // Splice æ¨¡å¼çš„çš„ä½¿ç”¨é™åˆ¶ï¼š

                                // Linux ç¯å¢ƒ
                                // å…¥ç«™åè®®ä¸º Dokodemo doorã€Socksã€HTTP ç­‰çº¯å‡€çš„ TCP è¿æ¥, æˆ–å…¶å®ƒä½¿ç”¨äº† XTLS çš„å…¥ç«™åè®®
                                // å‡ºç«™åè®®ä¸º VLESS + XTLS
                                // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ mKCP åè®®æ—¶ä¸ä¼šä½¿ç”¨ Spliceï¼ˆæ˜¯çš„ï¼Œè™½ç„¶æ²¡æœ‰æŠ¥é”™ï¼Œä½†å®é™…ä¸Šæ ¹æœ¬æ²¡ç”¨åˆ°
                                // æ­¤å¤–ï¼Œä½¿ç”¨ Splice æ—¶ç½‘é€Ÿæ˜¾ç¤ºä¼šæ»åï¼Œè¿™æ˜¯ç‰¹æ€§ï¼Œä¸æ˜¯ bugã€‚
                                // ä½¿ç”¨ Vision æ¨¡å¼ å¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ ä¼šè‡ªåŠ¨å¯ç”¨ Splice
                                "flow": "xtls-rprx-vision",
                                "id": "$uuid"  // ç”¨æˆ· IDï¼Œå¿…é¡»ä¸æœåŠ¡å™¨ç«¯é…ç½®ç›¸åŒ
                            }
                            ]
                    }
                    ]
            },
            "streamSettings": {
                "network": "tcp",
                // reality æ–¹å¼ï¼Œç”¨æˆ·æ— éœ€æ‹¥æœ‰è‡ªå·±çš„åŸŸåï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•åˆæ³•çš„ç½‘ç«™ï¼Œé€Ÿåº¦ä¹Ÿæ›´å¿«ã€‚
                "security": "reality",
                "realitySettings": {
                    "fingerprint": "chrome",
                    "serverName": "${client_server_name}",
                    "publicKey": "${reality_public_key}"
                },
                "sockopt": {
                    "tcpcongestion": "bbr", // å¦‚æœä¸è®¾å®šï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ç³»ç»Ÿè®¾ç½®
                    "tcpMptcp": true,
                    "tcpNoDelay": true,
                    "mark": 255
                }
            }
        },
        {
            "protocol": "shadowsocks",
            "settings": {
                "servers": [
                    {
                        "address": "$targetip", // Shadowsocks çš„æœåŠ¡å™¨åœ°å€
                        "method": "$ss_method", // Shadowsocks çš„åŠ å¯†æ–¹å¼
                        "password": "$ss_password", // Shadowsocks çš„å¯†ç 
                        "port": $ss_port
                    }
                ]
            },
            "streamSettings": {
                "sockopt": {
                    "mark": 255
                }
            }
        },
        {
            // è¯†åˆ«è¿™æ˜¯ä¸€ä¸ª DNS è¯·æ±‚ï¼Œ å¹¶å‘é€åˆ°å†…éƒ¨ DNS è¿›è¡ŒæŸ¥è¯¢.
            "tag": "dns-outbound",
            "protocol": "dns",
            "proxySettings": {
                "tag": "proxy"
            },
            "streamSettings": {
                "sockopt": {
                    "mark": 255
                }
            }
        },
        {
            "tag": "direct",
            "protocol": "freedom",
            "settings": {
                // è¿™é‡Œæˆ‘é€‰æ‹©åŠ ä¸Šè¯•è¯•, æä¸å¥½æˆ‘çš„æ–¹æ¡ˆ, freedom çœŸçš„åˆå»è®¿é—® dnsmasq
                // çš„ 53 ç«¯å£, åˆè¢«è½¬åˆ° V2ray çš„ DNS å‘¢.
                "domainStrategy": "UseIPv4"
            },
            "streamSettings": {
                "sockopt": {
                    "mark": 255
                }
            }
        },
        {
            "tag": "block",
            "protocol": "blackhole",
            "settings": {
                "response": {
                    "type": "http"
                }
            }
        }
        ],
    "policy": {
        "levels": {
            "0": {
                "bufferSize": 4
            }
        }
    }
}
HEREDOC

if [ "$use_xtls" != true ]; then
    replace_string '"protocol": "vless",' '"protocol": "vmess",' /etc/$service_name/client_config.json
    replace_multiline1 '"encryption": "none",\s*"flow": "xtls-rprx-.*?",' '' /etc/$service_name/client_config.json
    replace_multiline1 '"network": "tcp",\s*"security":.*?},' '"network": "quic",
               "quicSettings": {
                    "header": {
                        "type": "wechat-video"
                    }
                },' /etc/$service_name/client_config.json
fi

echo 'Congratulations, Deploy succssful!'
