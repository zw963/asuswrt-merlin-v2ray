#!/bin/bash

self="$(\curl -sS https://gitee.com/zw963/deployment_bash/raw/v0.7.2/deploy_start.sh)" && eval "$self"

export target=$1

config=./router/opt/etc/v2ray.json

if [ ! -e "$config" ]; then
    echo "Please create ${config} or generate it use ./deploy_server before deploy to side router."
    exit
fi

function postinstall () {
    set -u
    echo
    echo 'Please waiting for 10 seconds to check google available ...'
    sleep 10
    check_google=$(curl -so /dev/null -w 'Google: %{http_code}\n' google.com)
    if [[ "$check_google" =~ 301|200 ]]; then
        echo "visit google successful, Your's ip is: $(curl http://ipecho.net/plain; echo)"
    else
        echo 'visit google failed, something was wrong!'
    fi
}

ssh "$*" "sudo mkdir -p /opt/etc /opt/sbin /var/log/v2ray"
copy "$config" /opt/etc/
copy router/opt/etc/apply_iptables_rule.sh /opt/etc/
copy router/opt/etc/clean_iptables_rule.sh /opt/etc
copy router/opt/etc/update_geosite.sh /opt/etc
copy router/opt/etc/update_big_geosite.sh /opt/etc
copy router/opt/etc/toggle_proxy.sh /opt/etc
copy router/opt/etc/patch_router /opt/etc
copy router/opt/etc/iptables-rule.service /etc/systemd/system
copy router/opt/etc/check_google_use_proxy.sh /opt/etc
copy router/opt/etc/check_google_use_socks5.sh /opt/etc
copy router/opt/etc/debug_v2ray.sh /opt/etc

if [ -d predownloaded_binary ]; then
    echo 'Copy predownloaded binary to router ...'
    v2ray_zip_file=$(ls -1 predownloaded_binary/v2ray-linux-*.zip |head -n1)
    copy $v2ray_zip_file $v2ray_zip_file
    xray_zip_file=$(ls -1 predownloaded_binary/Xray-linux-*.zip |head -n1)
    copy $xray_zip_file $xray_zip_file
else
    ssh "$*" "rm -rf predownloaded_binary"
    echo 'Please download predownloaded binary into predownloaded_binary folder.'
    exit 1
fi

deploy_start

set -eu

# --------------------------------------------------------------------------------
#
# Following script will be run on router, please change it to meet your's need.
#
# -------------------------------------------------------------------------------

#
# å¦‚æžœç¬¬ä¸€æ¬¡è¿è¡Œæœ¬è„šæœ¬, è¯·åŠ¡å¿…æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

# 1. è½¯è·¯ç”±è®¾å®šä½¿ç”¨å›ºå®š IP,
# 2. è½¯è·¯ç”±å°† gateway ä»¥åŠ dns1 æŒ‡å®šåˆ°ä½ çš„ä¸»è·¯ç”±(WiFi è·¯ç”±å™¨) IP.
# 3. ä»¥ä¸Šè®¾å®šå®ŒåŽï¼Œåœ¨ä¸»è·¯ç”±é€šè¿‡(è·¯ç”±å™¨çš„) web ç•Œé¢ï¼Œå°†ç½‘å…³(gateway)ä»¥åŠç¬¬ä¸€ä¸ª dns(dns1)
#    è½¯è·¯ç”± IP åœ°å€.

# ä»¥ centos 7 ä¸ºä¾‹ï¼Œéœ€è¦é’ˆå¯¹ /etc/sysconfig/network-scripts/ifcfg-enp0s25
# åšå¦‚ä¸‹æ›´æ”¹ï¼š(enp0s25 ä¸ºç½‘å¡ interface)
# - ä¿®æ”¹ BOOTPROTO=none
# - è®¾å®š IPADDR=192.168.50.111 (åŒç½‘æ®µä»»æ„å›ºå®š IP)
# - è®¾å®š GATEWAY=192.168.50.1 (ä¸»è·¯ç”±å™¨ IP)
# - è®¾å®š DNS1=192.168.50.1 (ä¸»è·¯ç”± IP)
# - è®¾å®š PREFIX=24 (ç”¨æ¥åˆå§‹åŒ– netmask ç­‰)
# - for centos 7, systemctl restart network OR
#    for centos 8, nmcli connection down enp0s25 && sudo nmcli connection up enp0s25
# - å…³é—­ firewalld, å› ä¸ºå®ƒå¯èƒ½ä¼šé€ æˆ iptables-rule.service åœ¨å¯åŠ¨æ—¶å¤±è´¥ã€‚

# æœ€åŽï¼Œå¯é€‰çš„ï¼Œæ‰“å¼€ /etc/systemd/logind.conf, ä¿®æ”¹ä¸ºå¦‚ä¸‹è®¾ç½®ï¼Œæ¥é¿å…å…³é—­ç›–å­å¾…æœºã€‚
# [Login]
# HandleLidSwitch=ignore
# HandleLidSwitchDocked=ignore

# è¿˜éœ€è¦é˜»æ­¢è‡ªåŠ¨ suspend, ä»¥åŠ hibernate.(å–æ¶ˆä½¿ç”¨ unmask æ›¿æ¢ mask)
# $ systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

cd predownloaded_binary &&
    unzip -o v2ray-linux-64.zip &&
    unzip -o Xray-linux-64.zip &&
    chmod +x ./xray

if ./xray -version; then
    set +e; systemctl stop v2ray; set -e
    cp xray geosite.dat geoip-only-cn-private.dat /opt/sbin/
    cp systemd/system/*.service /etc/systemd/system
    replace_regex1 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray.service
    replace_regex1 'RestartPreventExitStatus=23' 'RestartPreventExitStatus=23
# Added by user
LimitNPROC=500
LimitNOFILE=1000000' /etc/systemd/system/v2ray@.service
    replace_string1 '/usr/local/bin/v2ray -config /usr/local/etc/v2ray/config.json' '/opt/sbin/xray run -config /opt/etc/v2ray.json' /etc/systemd/system/v2ray.service
    replace_string1 '/usr/local/bin/v2ray -config /usr/local/etc/v2ray/%i.json' '/opt/sbin/xray run -config /opt/etc/%i.json' /etc/systemd/system/v2ray@.service
    systemctl daemon-reload
else
    echo 'Not valid xray version is supported by current router, please download correct version.'
    exit
fi

echo 'xray is installed'

# ----------------------------------------------------
#
# ä¸‹é¢æ‰§è¡Œä¸€äº›è„šæœ¬æ£€æŸ¥ä¸Žæ›¿æ¢ã€‚
#
# ---------------------------------------------------

cd /opt/etc
chmod +x apply_iptables_rule.sh \
      clean_iptables_rule.sh \
      update_geosite.sh \
      update_big_geosite.sh \
      toggle_proxy.sh \
      patch_router \
      check_google_use_proxy.sh \
      check_google_use_socks5.sh \
      debug_v2ray.sh

# æ—è·¯ç”±ç›´æŽ¥åœ¨ 53 ç«¯å£ç›‘å¬
replace_string '65053' '53' /opt/etc/v2ray.json

# ä¸‹é¢çš„ iptables åœ¨æ—è·¯ç”±æ¨¡å¼ä¸‹ï¼Œæ— éœ€è®¾ç½®ã€‚
replace_string 'iptables -t mangle -A V2RAY_UDP -d 192.168.0.0/16 -p udp ! --dport 53 -j RETURN' 'iptables -t mangle -A V2RAY_UDP -d 192.168.0.0/16 -p udp -j RETURN' /opt/etc/apply_iptables_rule.sh
replace_regex 'iptables -t mangle -A V2RAY_UDP -p udp -j TPROXY --tproxy-mark 1 --on-port \$local_v2ray_port' '' /opt/etc/apply_iptables_rule.sh

/opt/etc/clean_iptables_rule.sh && chmod -x /opt/etc/apply_iptables_rule.sh
chmod +x /opt/etc/apply_iptables_rule.sh && /opt/etc/apply_iptables_rule.sh

# ----------------------------------------------------
#
# å¯åŠ¨æ‰€éœ€çš„è„šæœ¬
#
# ---------------------------------------------------

set +e
systemctl disable firewalld &>/dev/null
systemctl stop firewalld &>/dev/null
set -e
systemctl daemon-reload && systemctl start v2ray && systemctl enable v2ray && systemctl status v2ray
systemctl start iptables-rule &&  systemctl enable iptables-rule
cp /opt/etc/update_geosite.sh /etc/cron.weekly/

config_sysctl_for_proxy

/opt/etc/patch_router && echo "Congratulations, [0m[33mDeploy succssful[0m!"
